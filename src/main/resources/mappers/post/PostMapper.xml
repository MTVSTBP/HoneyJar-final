<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tbp.honeyjar.post.dao.PostMapper">

    <!-- 포스트 리스트 조회 -->
    <resultMap id="postListResultMap" type="com.tbp.honeyjar.post.dto.PostListDTO">
        <id property="postId" column="post_id"/>
        <result property="title" column="title"/>
        <result property="post" column="post"/>
    </resultMap>

    <!-- 포스트 상세 조회 -->
    <resultMap id="postResponseResultMap" type="com.tbp.honeyjar.post.dto.PostResponseDTO">
        <id property="postId" column="post_id"/>
        <result property="title" column="title"/>
        <result property="recommendMenu" column="recommend_menu"/>
        <result property="price" column="price"/>
        <result property="post" column="post"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="placeId" column="place_id"/>
        <result property="userId" column="user_id"/>
        <collection property="images" ofType="com.tbp.honeyjar.image.dto.ImageDTO" resultMap="imageResultMap"/>
    </resultMap>

    <resultMap id="imageResultMap" type="com.tbp.honeyjar.image.dto.ImageDTO">
        <id property="imageId" column="image_id"/>
        <result property="url" column="url"/>
        <result property="isMain" column="is_main"/>
    </resultMap>

    <!-- 포스트 리스트 조회 쿼리 -->
    <select id="findAllPost" resultMap="postListResultMap">
        SELECT
        p.post_id,
        p.title,
        p.post
        FROM
        post p
    </select>

    <!-- 포스트 상세 조회 쿼리 -->
    <select id="findPostById" resultMap="postResponseResultMap">
        SELECT
        p.post_id,
        p.title,
        p.recommend_menu,
        p.price,
        p.post,
        p.created_at,
        p.updated_at,
        p.place_id,
        p.user_id,
        i.image_id,
        i.url,
        i.is_main
        FROM
        post p
        LEFT JOIN
        image i ON p.post_id = i.post_id
        WHERE
        p.post_id = #{postId}
    </select>

    <!-- 포스트 등록 쿼리 -->
    <insert id="createPost" useGeneratedKeys="true" keyProperty="postId">
        INSERT INTO post (
        title,
        recommend_menu,
        price,
        post,
        created_at,
        place_id,
        user_id,
        category_id  <!-- 추가 -->
        )
        VALUES (
        #{title},
        #{recommendMenu},
        #{price},
        #{post},
        NOW(),
        #{placeId},
        #{userId},
        #{categoryId}  <!-- 추가 -->
        )
    </insert>

    <!-- 포스트 수정 쿼리 -->
    <update id="updatePost">
        UPDATE post
        SET
        title = #{title},
        recommend_menu = #{recommendMenu},
        price = #{price},
        post = #{post},
        updated_at = NOW(),
        place_id = #{placeId} <!-- placeId를 포함 -->
        WHERE post_id = #{postId}
    </update>
</mapper>
